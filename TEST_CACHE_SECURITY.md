# 本地缓存安全测试指南

## 🧪 测试步骤

### 测试 1: 用户隔离测试

#### 步骤：
1. **用户 A 登录**
   ```
   - 访问 /login
   - 使用用户 A 的账号登录
   ```

2. **创建草稿**
   ```
   - 访问 /notes/new
   - 输入标题："用户A的笔记"
   - 输入内容："这是用户A的私密内容"
   - 不要点击保存，直接关闭标签页
   ```

3. **用户 A 登出**
   ```
   - 点击右上角的登出按钮
   ```

4. **用户 B 登录**
   ```
   - 访问 /login
   - 使用用户 B 的账号登录
   ```

5. **检查缓存**
   ```
   - 访问 /notes/new
   - 检查编辑器是否为空
   ```

#### 预期结果：
- ✅ 用户 B 看到的是空白编辑器
- ✅ 用户 A 的草稿不会显示
- ✅ 控制台显示："已清理 X 个其他用户的缓存"

#### 实际结果：
- [ ] 通过
- [ ] 失败

---

### 测试 2: 同一用户草稿恢复

#### 步骤：
1. **用户 A 登录**
   ```
   - 访问 /login
   - 使用用户 A 的账号登录
   ```

2. **创建草稿**
   ```
   - 访问 /notes/new
   - 输入标题："测试草稿"
   - 输入内容："这是测试内容"
   - 不要保存
   ```

3. **刷新页面**
   ```
   - 按 F5 或点击刷新按钮
   ```

4. **检查恢复**
   ```
   - 查看编辑器内容
   - 查看是否有"已恢复未保存的草稿"提示
   ```

#### 预期结果：
- ✅ 草稿内容被恢复
- ✅ 显示提示："已恢复未保存的草稿"
- ✅ 标题和内容都正确恢复

#### 实际结果：
- [ ] 通过
- [ ] 失败

---

### 测试 3: 编辑现有笔记的草稿

#### 步骤：
1. **创建并保存笔记**
   ```
   - 创建一个新笔记
   - 标题："原始笔记"
   - 内容："原始内容"
   - 点击保存
   ```

2. **编辑但不保存**
   ```
   - 点击编辑按钮
   - 修改内容为："修改后的内容"
   - 不要保存，关闭标签页
   ```

3. **重新打开编辑**
   ```
   - 再次打开该笔记的编辑页面
   ```

#### 预期结果：
- ✅ 显示修改后的内容："修改后的内容"
- ✅ 显示提示："已恢复未保存的草稿"

#### 实际结果：
- [ ] 通过
- [ ] 失败

---

### 测试 4: 缓存键格式验证

#### 步骤：
1. **打开浏览器开发者工具**
   ```
   - 按 F12
   - 切换到 Application/存储 标签
   - 展开 Local Storage
   ```

2. **创建草稿**
   ```
   - 登录并创建新笔记
   - 输入一些内容但不保存
   ```

3. **检查缓存键**
   ```
   - 在 localStorage 中查找以 "note-draft-" 开头的键
   ```

#### 预期结果：
- ✅ 缓存键格式为：`note-draft-{userId}-new` 或 `note-draft-{userId}-{noteId}`
- ✅ 缓存值包含 `userId` 字段
- ✅ 缓存值包含 `timestamp` 字段

#### 实际结果：
- [ ] 通过
- [ ] 失败

---

### 测试 5: 自动清理功能

#### 步骤：
1. **手动创建旧缓存**
   ```javascript
   // 在浏览器控制台执行
   localStorage.setItem('note-draft-old-user-123', JSON.stringify({
     content: '旧用户的内容',
     title: '旧标题',
     userId: 'old-user-id',
     timestamp: Date.now() - (8 * 24 * 60 * 60 * 1000) // 8天前
   }))
   ```

2. **刷新页面**
   ```
   - 按 F5 刷新
   ```

3. **检查缓存**
   ```
   - 打开开发者工具
   - 检查 localStorage
   - 查看控制台日志
   ```

#### 预期结果：
- ✅ 旧缓存被清理
- ✅ 控制台显示："已清理 X 个过期缓存"

#### 实际结果：
- [ ] 通过
- [ ] 失败

---

### 测试 6: API Session 端点

#### 步骤：
1. **登录后测试**
   ```bash
   curl http://localhost:3000/api/auth/session
   ```

2. **未登录测试**
   ```
   - 登出
   - 再次访问 /api/auth/session
   ```

#### 预期结果：
- ✅ 登录时返回：`{ user: { id, email, name } }`
- ✅ 未登录时返回：`{ user: null }`

#### 实际结果：
- [ ] 通过
- [ ] 失败

---

## 🔍 调试技巧

### 查看所有缓存
```javascript
// 在浏览器控制台执行
for (let i = 0; i < localStorage.length; i++) {
  const key = localStorage.key(i)
  if (key?.startsWith('note-draft-')) {
    console.log(key, JSON.parse(localStorage.getItem(key)))
  }
}
```

### 手动清理所有缓存
```javascript
// 在浏览器控制台执行
for (let i = localStorage.length - 1; i >= 0; i--) {
  const key = localStorage.key(i)
  if (key?.startsWith('note-draft-')) {
    localStorage.removeItem(key)
  }
}
console.log('所有笔记缓存已清理')
```

### 查看当前用户 ID
```javascript
// 在浏览器控制台执行
fetch('/api/auth/session')
  .then(r => r.json())
  .then(data => console.log('当前用户:', data.user))
```

---

## ✅ 测试检查清单

- [ ] 测试 1: 用户隔离测试
- [ ] 测试 2: 同一用户草稿恢复
- [ ] 测试 3: 编辑现有笔记的草稿
- [ ] 测试 4: 缓存键格式验证
- [ ] 测试 5: 自动清理功能
- [ ] 测试 6: API Session 端点

---

## 📊 测试报告模板

```
测试日期: ___________
测试人员: ___________

测试结果:
- 通过: ___ / 6
- 失败: ___ / 6

问题描述:
1. ___________
2. ___________

建议:
1. ___________
2. ___________
```

---

## 🚨 常见问题

### Q: 草稿没有恢复？
A: 检查：
1. 是否是同一个用户登录
2. 缓存是否超过 24 小时
3. 浏览器是否清除了 localStorage

### Q: 看到了其他用户的草稿？
A: 这是严重问题，请：
1. 检查 userId 是否正确获取
2. 检查缓存键是否包含 userId
3. 查看控制台错误日志

### Q: 自动清理没有触发？
A: 检查：
1. CacheCleanup 组件是否正确加载
2. userId 是否传递正确
3. 查看控制台日志

---

## 💡 提示

- 使用不同的浏览器或隐私模式模拟不同用户
- 使用开发者工具的 Application 标签查看 localStorage
- 查看浏览器控制台的日志输出
- 测试时注意清理测试数据
