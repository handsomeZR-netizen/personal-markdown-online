# ğŸš¨ ä¿®å¤æ³¨å†Œ 500 é”™è¯¯

## é”™è¯¯ä¿¡æ¯
```
Failed to load resource: the server responded with a status of 500 ()
api/auth/register:1 Failed to load resource: the server responded with a status of 500 ()
```

## å¯èƒ½çš„åŸå› 

### 1. ç¯å¢ƒå˜é‡æœªé…ç½® â­ æœ€å¸¸è§
Vercel ä¸Šæ²¡æœ‰é…ç½®æ•°æ®åº“è¿æ¥ç¯å¢ƒå˜é‡ã€‚

### 2. æ•°æ®åº“è¡¨æœªåˆ›å»º
Prisma è¿ç§»æ²¡æœ‰åœ¨ Vercel æ•°æ®åº“ä¸Šæ‰§è¡Œã€‚

### 3. æ•°æ®åº“è¿æ¥å¤±è´¥
DATABASE_URL æ ¼å¼é”™è¯¯æˆ–æ•°æ®åº“ä¸å¯è®¿é—®ã€‚

---

## âš¡ å¿«é€Ÿä¿®å¤æ­¥éª¤

### æ­¥éª¤ 1: æ£€æŸ¥ Vercel ç¯å¢ƒå˜é‡

1. ç™»å½• https://vercel.com/dashboard
2. é€‰æ‹©é¡¹ç›® `personal-markdown-online`
3. Settings â†’ Environment Variables
4. **ç¡®è®¤ä»¥ä¸‹å˜é‡å­˜åœ¨**ï¼š

```bash
âœ… DATABASE_URL
âœ… DIRECT_URL
âœ… POSTGRES_USER
âœ… POSTGRES_PASSWORD
âœ… AUTH_SECRET
âœ… NEXT_PUBLIC_SUPABASE_URL
âœ… NEXT_PUBLIC_SUPABASE_ANON_KEY
âœ… SUPABASE_SERVICE_ROLE_KEY
```

å¦‚æœç¼ºå°‘ä»»ä½•å˜é‡ï¼Œç«‹å³æ·»åŠ ï¼ˆå‚è€ƒ `.env.local` æ–‡ä»¶ï¼‰ã€‚

### æ­¥éª¤ 2: éªŒè¯ DATABASE_URL æ ¼å¼

**æ­£ç¡®æ ¼å¼**ï¼ˆæ³¨æ„ç«¯å£å’Œå‚æ•°ï¼‰ï¼š
```bash
# åº”ç”¨è¿æ¥ï¼ˆç«¯å£ 6543ï¼Œå¸¦ pgbouncerï¼‰
DATABASE_URL=postgresql://postgres:YOUR_PASSWORD@db.PROJECT_ID.supabase.co:6543/postgres?pgbouncer=true

# ç›´è¿ï¼ˆç«¯å£ 5432ï¼Œç”¨äºè¿ç§»ï¼‰
DIRECT_URL=postgresql://postgres:YOUR_PASSWORD@db.PROJECT_ID.supabase.co:5432/postgres
```

**å¸¸è§é”™è¯¯**ï¼š
- âŒ ç«¯å£é”™è¯¯ï¼ˆåº”è¯¥æ˜¯ 6543 å’Œ 5432ï¼‰
- âŒ ç¼ºå°‘ `?pgbouncer=true`
- âŒ å¯†ç åŒ…å«ç‰¹æ®Šå­—ç¬¦æœªç¼–ç 
- âŒ é¡¹ç›® ID é”™è¯¯

### æ­¥éª¤ 3: åœ¨ Supabase è¿è¡Œæ•°æ®åº“è¿ç§»

#### æ–¹æ³• A: ä½¿ç”¨ Supabase SQL Editorï¼ˆæ¨èï¼‰

1. è®¿é—® https://supabase.com/dashboard
2. é€‰æ‹©ä½ çš„é¡¹ç›®
3. ç‚¹å‡»å·¦ä¾§ **SQL Editor**
4. ç‚¹å‡» **New Query**
5. å¤åˆ¶ç²˜è´´ä»¥ä¸‹ SQLï¼š

```sql
-- åˆ›å»º User è¡¨
CREATE TABLE IF NOT EXISTS "User" (
    id TEXT PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    password TEXT NOT NULL,
    name TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS "User_email_idx" ON "User"(email);

-- åˆ›å»º Category è¡¨
CREATE TABLE IF NOT EXISTS "Category" (
    id TEXT PRIMARY KEY,
    name TEXT UNIQUE NOT NULL
);

-- åˆ›å»º Tag è¡¨
CREATE TABLE IF NOT EXISTS "Tag" (
    id TEXT PRIMARY KEY,
    name TEXT UNIQUE NOT NULL
);

-- åˆ›å»º Note è¡¨
CREATE TABLE IF NOT EXISTS "Note" (
    id TEXT PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    summary TEXT,
    embedding TEXT,
    "userId" TEXT NOT NULL,
    "categoryId" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "Note_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User"(id) ON DELETE CASCADE,
    CONSTRAINT "Note_categoryId_fkey" FOREIGN KEY ("categoryId") REFERENCES "Category"(id)
);

-- åˆ›å»º Note ç´¢å¼•
CREATE INDEX IF NOT EXISTS "Note_userId_idx" ON "Note"("userId");
CREATE INDEX IF NOT EXISTS "Note_createdAt_idx" ON "Note"("createdAt");
CREATE INDEX IF NOT EXISTS "Note_updatedAt_idx" ON "Note"("updatedAt");
CREATE INDEX IF NOT EXISTS "Note_userId_createdAt_idx" ON "Note"("userId", "createdAt");
CREATE INDEX IF NOT EXISTS "Note_categoryId_idx" ON "Note"("categoryId");

-- åˆ›å»º Note-Tag å…³è”è¡¨
CREATE TABLE IF NOT EXISTS "_NoteToTag" (
    "A" TEXT NOT NULL,
    "B" TEXT NOT NULL,
    CONSTRAINT "_NoteToTag_A_fkey" FOREIGN KEY ("A") REFERENCES "Note"(id) ON DELETE CASCADE,
    CONSTRAINT "_NoteToTag_B_fkey" FOREIGN KEY ("B") REFERENCES "Tag"(id) ON DELETE CASCADE
);

-- åˆ›å»ºå…³è”è¡¨ç´¢å¼•
CREATE UNIQUE INDEX IF NOT EXISTS "_NoteToTag_AB_unique" ON "_NoteToTag"("A", "B");
CREATE INDEX IF NOT EXISTS "_NoteToTag_B_index" ON "_NoteToTag"("B");

-- åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW."updatedAt" = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- ä¸º User è¡¨æ·»åŠ è§¦å‘å™¨
DROP TRIGGER IF EXISTS update_user_updated_at ON "User";
CREATE TRIGGER update_user_updated_at
    BEFORE UPDATE ON "User"
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- ä¸º Note è¡¨æ·»åŠ è§¦å‘å™¨
DROP TRIGGER IF EXISTS update_note_updated_at ON "Note";
CREATE TRIGGER update_note_updated_at
    BEFORE UPDATE ON "Note"
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

6. ç‚¹å‡» **Run** æ‰§è¡Œ SQL
7. ç¡®è®¤æ‰€æœ‰è¯­å¥æ‰§è¡ŒæˆåŠŸï¼ˆç»¿è‰²å‹¾å·ï¼‰

#### æ–¹æ³• B: ä½¿ç”¨ Prisma Migrateï¼ˆæœ¬åœ°ï¼‰

å¦‚æœä½ æœ‰æœ¬åœ°è®¿é—®æƒé™ï¼š

```bash
# 1. ç¡®ä¿ .env.local é…ç½®æ­£ç¡®
npm run check:env

# 2. æ¨é€ schema åˆ°æ•°æ®åº“
npx prisma db push

# 3. ç”Ÿæˆ Prisma Client
npx prisma generate
```

### æ­¥éª¤ 4: éªŒè¯æ•°æ®åº“è¡¨

åœ¨ Supabase Dashboardï¼š
1. ç‚¹å‡»å·¦ä¾§ **Table Editor**
2. åº”è¯¥çœ‹åˆ°ä»¥ä¸‹è¡¨ï¼š
   - âœ… User
   - âœ… Note
   - âœ… Tag
   - âœ… Category
   - âœ… _NoteToTag

### æ­¥éª¤ 5: é‡æ–°éƒ¨ç½² Vercel

```bash
# è§¦å‘é‡æ–°éƒ¨ç½²
git commit --allow-empty -m "chore: trigger redeploy after db setup"
git push
```

æˆ–åœ¨ Vercel Dashboard æ‰‹åŠ¨é‡æ–°éƒ¨ç½²ã€‚

---

## âœ… éªŒè¯ä¿®å¤

### 1. æ£€æŸ¥ Vercel å‡½æ•°æ—¥å¿—

1. Vercel Dashboard â†’ Deployments â†’ é€‰æ‹©æœ€æ–°éƒ¨ç½²
2. ç‚¹å‡» **Functions** æ ‡ç­¾
3. æ‰¾åˆ° `/api/auth/register` çš„æ—¥å¿—
4. æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

**åº”è¯¥çœ‹åˆ°**ï¼š
```
æ”¶åˆ°æ³¨å†Œè¯·æ±‚
è¯·æ±‚ä½“: { email: "...", password: "...", name: "..." }
éªŒè¯é€šè¿‡: { email: "...", name: "..." }
å¯†ç åŠ å¯†å®Œæˆ
ç”¨æˆ·åˆ›å»ºæˆåŠŸ: clxxx...
```

**ä¸åº”è¯¥çœ‹åˆ°**ï¼š
- âŒ `PrismaClientInitializationError`
- âŒ `Can't reach database server`
- âŒ `relation "User" does not exist`

### 2. æµ‹è¯•æ³¨å†ŒåŠŸèƒ½

1. è®¿é—® https://personal-markdown-online.vercel.app/register
2. å¡«å†™æ³¨å†Œè¡¨å•
3. æäº¤
4. åº”è¯¥æˆåŠŸæ³¨å†Œå¹¶è·³è½¬

### 3. æ£€æŸ¥ Supabase æ•°æ®

1. Supabase Dashboard â†’ Table Editor â†’ User
2. åº”è¯¥çœ‹åˆ°æ–°åˆ›å»ºçš„ç”¨æˆ·è®°å½•

---

## ğŸ› å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

### é”™è¯¯ 1: `relation "User" does not exist`

**åŸå› **ï¼šæ•°æ®åº“è¡¨æœªåˆ›å»º

**è§£å†³**ï¼š
1. åœ¨ Supabase SQL Editor è¿è¡Œä¸Šé¢çš„ SQL
2. æˆ–ä½¿ç”¨ `npx prisma db push`

---

### é”™è¯¯ 2: `Can't reach database server`

**åŸå› **ï¼šDATABASE_URL é”™è¯¯æˆ–æ•°æ®åº“ä¸å¯è®¿é—®

**æ£€æŸ¥**ï¼š
1. DATABASE_URL æ ¼å¼æ­£ç¡®
2. Supabase é¡¹ç›®çŠ¶æ€æ­£å¸¸
3. å¯†ç æ­£ç¡®

**æµ‹è¯•è¿æ¥**ï¼š
```bash
# æœ¬åœ°æµ‹è¯•
npx prisma db pull
```

---

### é”™è¯¯ 3: `Invalid `prisma.user.create()` invocation`

**åŸå› **ï¼šPrisma Client æœªç”Ÿæˆæˆ–ç‰ˆæœ¬ä¸åŒ¹é…

**è§£å†³**ï¼š
```bash
npx prisma generate
```

ç„¶åé‡æ–°éƒ¨ç½²ã€‚

---

### é”™è¯¯ 4: `P2002: Unique constraint failed`

**åŸå› **ï¼šé‚®ç®±å·²å­˜åœ¨

**è¿™æ˜¯æ­£å¸¸çš„**ï¼šè¯´æ˜æ•°æ®åº“è¿æ¥æ­£å¸¸ï¼Œåªæ˜¯ç”¨æˆ·å·²æ³¨å†Œã€‚

---

### é”™è¯¯ 5: ç¯å¢ƒå˜é‡åœ¨ Vercel ä¸Šä¸ç”Ÿæ•ˆ

**åŸå› **ï¼šæ·»åŠ ç¯å¢ƒå˜é‡åæ²¡æœ‰é‡æ–°éƒ¨ç½²

**è§£å†³**ï¼š
1. æ·»åŠ /ä¿®æ”¹ç¯å¢ƒå˜é‡å
2. å¿…é¡»é‡æ–°éƒ¨ç½²æ‰èƒ½ç”Ÿæ•ˆ
3. ä½¿ç”¨ `git push` æˆ–æ‰‹åŠ¨ Redeploy

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

åœ¨ `route.ts` ä¸­å·²ç»æœ‰è¯¦ç»†æ—¥å¿—ï¼š
```typescript
console.log("ENV DATABASE_URL:", process.env.DATABASE_URL)
console.log("ENV DIRECT_URL:", process.env.DIRECT_URL)
```

åœ¨ Vercel Functions æ—¥å¿—ä¸­æŸ¥çœ‹è¿™äº›è¾“å‡ºã€‚

### 2. æµ‹è¯•æ•°æ®åº“è¿æ¥

åˆ›å»ºä¸€ä¸ªæµ‹è¯• APIï¼š

```typescript
// src/app/api/test-db/route.ts
import { NextResponse } from "next/server"
import { prisma } from "@/lib/prisma"

export async function GET() {
  try {
    await prisma.$connect()
    const userCount = await prisma.user.count()
    return NextResponse.json({ 
      success: true, 
      userCount,
      message: "æ•°æ®åº“è¿æ¥æˆåŠŸ" 
    })
  } catch (error: any) {
    return NextResponse.json({ 
      success: false, 
      error: error.message 
    }, { status: 500 })
  }
}
```

è®¿é—® `/api/test-db` æµ‹è¯•è¿æ¥ã€‚

### 3. æœ¬åœ°æµ‹è¯•ç”Ÿäº§ç¯å¢ƒ

```bash
# ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒå˜é‡
npm run build
npm start

# æµ‹è¯•æ³¨å†Œ
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"123456","name":"Test"}'
```

---

## ğŸ“‹ å®Œæ•´æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰ç¡®è®¤ï¼š

- [ ] Vercel ç¯å¢ƒå˜é‡å·²é…ç½®
  - [ ] DATABASE_URL
  - [ ] DIRECT_URL
  - [ ] AUTH_SECRET
  - [ ] SUPABASE_SERVICE_ROLE_KEY
  - [ ] å…¶ä»–å¿…éœ€å˜é‡

- [ ] æ•°æ®åº“è¡¨å·²åˆ›å»º
  - [ ] User è¡¨
  - [ ] Note è¡¨
  - [ ] Tag è¡¨
  - [ ] Category è¡¨
  - [ ] _NoteToTag å…³è”è¡¨

- [ ] Prisma é…ç½®æ­£ç¡®
  - [ ] schema.prisma æ­£ç¡®
  - [ ] Prisma Client å·²ç”Ÿæˆ

- [ ] æœ¬åœ°æµ‹è¯•é€šè¿‡
  - [ ] `npm run build` æˆåŠŸ
  - [ ] `npm run check:env` é€šè¿‡
  - [ ] æœ¬åœ°å¯ä»¥æ³¨å†Œ

---

## ğŸ“ ä»ç„¶æœ‰é—®é¢˜ï¼Ÿ

### æŸ¥çœ‹æ—¥å¿—

1. **Vercel å‡½æ•°æ—¥å¿—**
   ```
   Vercel â†’ Deployments â†’ Functions â†’ /api/auth/register
   ```

2. **æµè§ˆå™¨æ§åˆ¶å°**
   ```
   F12 â†’ Console â†’ æŸ¥çœ‹é”™è¯¯è¯¦æƒ…
   ```

3. **Network æ ‡ç­¾**
   ```
   F12 â†’ Network â†’ æŸ¥çœ‹è¯·æ±‚/å“åº”
   ```

### æä¾›ä¿¡æ¯

å¦‚æœéœ€è¦å¸®åŠ©ï¼Œè¯·æä¾›ï¼š
1. Vercel å‡½æ•°æ—¥å¿—æˆªå›¾
2. æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯
3. ç¯å¢ƒå˜é‡é…ç½®ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
4. Supabase é¡¹ç›®çŠ¶æ€

---

## ğŸ’¡ é¢„é˜²æªæ–½

1. **ä½¿ç”¨ Supabase è¿ç§»**
   - åœ¨ Supabase ä¸Šç›´æ¥è¿è¡Œ SQL
   - é¿å…æœ¬åœ°è¿ç§»åŒæ­¥é—®é¢˜

2. **ç¯å¢ƒå˜é‡ç®¡ç†**
   - ä½¿ç”¨ `.env.example` ä½œä¸ºæ¨¡æ¿
   - å®šæœŸè¿è¡Œ `npm run check:env`

3. **éƒ¨ç½²å‰æµ‹è¯•**
   - æœ¬åœ°æµ‹è¯•ç”Ÿäº§æ„å»º
   - éªŒè¯æ‰€æœ‰ API ç«¯ç‚¹

4. **ç›‘æ§æ—¥å¿—**
   - å®šæœŸæŸ¥çœ‹ Vercel æ—¥å¿—
   - è®¾ç½®é”™è¯¯å‘Šè­¦

---

**é‡è¦æç¤º**ï¼š
1. æ·»åŠ ç¯å¢ƒå˜é‡åå¿…é¡»é‡æ–°éƒ¨ç½²
2. æ•°æ®åº“è¡¨å¿…é¡»å…ˆåˆ›å»ºæ‰èƒ½ä½¿ç”¨
3. DATABASE_URL æ ¼å¼å¿…é¡»æ­£ç¡®ï¼ˆç«¯å£ 6543 + pgbouncer=trueï¼‰
